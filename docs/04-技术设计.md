# CC Connect 技术设计文档

> 版本：v1.0 | 更新日期：2026-01-21

---

## 1. 系统架构

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户设备                                 │
│  ┌─────────────┐                           ┌─────────────────┐  │
│  │   iPhone    │                           │      Mac        │  │
│  │  ┌───────┐  │                           │  ┌───────────┐  │  │
│  │  │CC App │  │                           │  │  CC CLI   │  │  │
│  │  └───┬───┘  │                           │  └─────┬─────┘  │  │
│  └──────┼──────┘                           └────────┼────────┘  │
│         │                                           │            │
└─────────┼───────────────────────────────────────────┼────────────┘
          │ WebSocket                                 │ WebSocket
          │                                           │
┌─────────▼───────────────────────────────────────────▼────────────┐
│                      云端中继服务                                 │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  Cloudflare Workers                         │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌────────────┐  │ │
│  │  │WebSocket │  │ 会话管理  │  │ 消息路由  │  │ 推送服务   │  │ │
│  │  │  Hub     │  │          │  │          │  │  (APNs)    │  │ │
│  │  └──────────┘  └──────────┘  └──────────┘  └────────────┘  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                              │                                    │
│                     ┌────────▼────────┐                          │
│                     │  Cloudflare KV  │                          │
│                     │  (会话状态存储)  │                          │
│                     └─────────────────┘                          │
└──────────────────────────────────────────────────────────────────┘
```

### 1.2 组件职责

| 组件 | 技术 | 职责 |
|------|------|------|
| **CC App** | SwiftUI | 用户界面、WebSocket 客户端、推送处理 |
| **CC CLI** | Node.js | PTY 包装 Claude Code、状态解析、WebSocket 客户端 |
| **云端中继** | Cloudflare Workers | WebSocket 转发、会话管理、APNs 推送 |
| **存储** | Cloudflare KV | 会话状态、配对信息、设备 token |

---

## 2. 技术选型

### 2.1 iOS App

| 层级 | 技术 | 版本 | 选择理由 |
|------|------|------|----------|
| UI | SwiftUI | iOS 17+ | 原生体验，开发效率高 |
| 数据 | SwiftData | iOS 17+ | 与 SwiftUI 深度集成 |
| 网络 | URLSession WebSocket | 内置 | 原生支持，无需依赖 |
| 推送 | APNs | - | iOS 标准方案 |
| 架构 | MVVM + Store | - | 状态管理清晰 |

### 2.2 CLI 工具

| 层级 | 技术 | 选择理由 |
|------|------|----------|
| 运行时 | Node.js 18+ | 跨平台，npm 分发方便 |
| PTY | node-pty | 成熟的伪终端库 |
| WebSocket | ws | 轻量、可靠 |
| 二维码 | qrcode-terminal | 终端显示二维码 |
| CLI 框架 | Commander.js | 简洁的命令行解析 |

### 2.3 云端服务

| 层级 | 技术 | 选择理由 |
|------|------|----------|
| 计算 | Cloudflare Workers | 全球边缘、低延迟、免费额度大 |
| 存储 | Cloudflare KV | 与 Workers 深度集成 |
| WebSocket | Durable Objects | 有状态 WebSocket 连接 |
| 推送 | APNs HTTP/2 | iOS 推送标准 |

---

## 3. 核心流程

### 3.1 配对流程

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│   CLI   │     │  云端    │     │   App   │
└────┬────┘     └────┬────┘     └────┬────┘
     │               │               │
     │──(1)生成配对码──>│               │
     │<──(2)返回会话ID──│               │
     │               │               │
     │  [显示二维码]   │               │
     │               │               │
     │               │<──(3)扫码,提交配对码──
     │               │               │
     │               │──(4)验证配对码──>│
     │               │               │
     │<──(5)配对成功通知─│──(5)配对成功──>│
     │               │               │
     │====(6)建立WebSocket双向通道====│
     │               │               │
```

**配对码格式**：`cc://<session_id>:<secret>`
- `session_id`：UUID，会话唯一标识
- `secret`：随机字符串，用于验证

### 3.2 消息同步流程

```
┌─────────┐     ┌─────────┐     ┌─────────┐
│   CLI   │     │  云端    │     │   App   │
└────┬────┘     └────┬────┘     └────┬────┘
     │               │               │
     │ [Claude输出]   │               │
     │               │               │
     │──(1)output消息──>│               │
     │               │──(2)转发────────>│
     │               │               │
     │               │     [显示输出]  │
     │               │               │
     │ [需要输入]     │               │
     │               │               │
     │──(3)input_required──>│          │
     │               │──(4)转发+推送───>│
     │               │               │
     │               │     [收到通知]  │
     │               │               │
     │               │<──(5)用户输入───│
     │<──(6)转发输入──│               │
     │               │               │
     │ [发送给Claude] │               │
```

### 3.3 消息类型定义

```typescript
// CLI -> 云端 -> App
type CLIMessage =
  | { type: 'output', data: string, timestamp: number }
  | { type: 'status', status: 'running' | 'waiting' | 'idle' | 'error' }
  | { type: 'input_required', prompt?: string }
  | { type: 'task_complete', summary?: string }
  | { type: 'error', message: string }

// App -> 云端 -> CLI
type AppMessage =
  | { type: 'input', text: string }
  | { type: 'interrupt' }
  | { type: 'ping' }
```

---

## 4. 数据模型

### 4.1 iOS App 数据模型（SwiftData）

```swift
@Model
class Session {
    @Attribute(.unique) var id: String
    var name: String
    var status: SessionStatus
    var lastActivity: Date
    var isConnected: Bool

    @Relationship(deleteRule: .cascade)
    var messages: [Message] = []
}

@Model
class Message {
    var id: String
    var type: MessageType
    var content: String
    var timestamp: Date

    var session: Session?
}

enum SessionStatus: String, Codable {
    case running
    case waiting
    case idle
    case error
    case disconnected
}

enum MessageType: String, Codable {
    case output
    case input
    case system
}
```

### 4.2 云端存储（Cloudflare KV）

```
会话信息:
  Key: session:{session_id}
  Value: {
    id: string,
    secret: string,
    cli_connected: boolean,
    app_connected: boolean,
    device_token: string | null,
    created_at: number,
    last_activity: number
  }

设备映射:
  Key: device:{device_id}
  Value: {
    sessions: string[],  // session_id 列表
    push_token: string
  }
```

---

## 5. 接口设计

### 5.1 REST API（配对阶段）

```
POST /api/session/create
  Request: { device_type: 'cli' }
  Response: { session_id, secret, qr_code_data }

POST /api/session/pair
  Request: { session_id, secret, device_token }
  Response: { success: boolean }

GET /api/session/{session_id}/status
  Response: { cli_connected, app_connected, last_activity }
```

### 5.2 WebSocket 协议

```
连接: wss://api.cc-connect.app/ws/{session_id}?token={secret}

心跳: 每 30 秒发送 { type: 'ping' }

消息格式: JSON
```

---

## 6. 安全考量

### 6.1 传输安全
- 所有通信使用 HTTPS/WSS
- WebSocket 连接需要 secret token 验证

### 6.2 会话安全
- session_id 使用 UUID v4
- secret 使用 32 字节随机字符串
- 会话 7 天无活动自动过期

### 6.3 数据安全
- 云端不持久化消息内容（仅转发）
- 用户输入在转发后立即丢弃
- 设备 token 加密存储

### 6.4 隐私说明
- 代码内容会经过云端转发（不存储）
- 如果用户有顾虑，后续可提供本地模式（P2P）

---

## 7. 性能考量

### 7.1 延迟目标
| 场景 | 目标 | 策略 |
|------|------|------|
| 消息转发 | < 500ms | Cloudflare 边缘节点 |
| 推送到达 | < 3s | APNs 高优先级 |
| 配对完成 | < 5s | 轻量级验证 |

### 7.2 并发处理
- Durable Objects 单实例处理单会话
- 避免跨实例状态同步

### 7.3 带宽优化
- 大输出分片传输（每片 < 64KB）
- 考虑 gzip 压缩

---

## 8. 开发计划

### 8.1 里程碑

| 阶段 | 内容 | 交付物 |
|------|------|--------|
| M1 | CLI 核心功能 | PTY 包装、二维码生成、WebSocket 连接 |
| M2 | 云端服务 | Workers 部署、消息转发、APNs 集成 |
| M3 | iOS App 核心 | 配对、消息展示、输入发送 |
| M4 | 联调测试 | 端到端测试、性能优化 |

### 8.2 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| Claude Code 输出格式变化 | 中 | 高 | 解析逻辑模块化，快速适配 |
| Cloudflare Workers 限制 | 低 | 中 | 监控用量，必要时升级方案 |
| WebSocket 连接不稳定 | 中 | 中 | 自动重连 + 消息确认机制 |

---

## 9. 第三方依赖

### iOS App
| 库名 | 用途 | 许可证 |
|------|------|--------|
| 无外部依赖 | - | - |

### CLI
| 库名 | 用途 | 许可证 |
|------|------|--------|
| node-pty | 伪终端 | MIT |
| ws | WebSocket | MIT |
| commander | CLI 框架 | MIT |
| qrcode-terminal | 二维码显示 | ISC |
| nanoid | ID 生成 | MIT |

---

## 附录

### A. 本地开发环境

```bash
# CLI 开发
cd cc-cli
npm install
npm run dev

# iOS 开发
open "cc connect.xcodeproj"

# 云端开发
cd cc-worker
npx wrangler dev
```

### B. 部署流程

```bash
# CLI 发布
npm publish

# 云端部署
npx wrangler deploy

# iOS 发布
通过 Xcode Archive & App Store Connect
```

---

**文档状态**：草稿
**负责人**：花叔
**评审状态**：待评审
